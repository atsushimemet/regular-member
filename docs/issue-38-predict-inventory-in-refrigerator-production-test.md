# Issue #38 予測機能 - 本番環境テスト計画

このドキュメントでは、Issue #38の予測機能開発におけるフェーズ0-1の本番環境でのテスト計画を説明します。

## 概要

### テスト対象
- **フェーズ0**: フラグ設定・監視基盤の動作確認
- **フェーズ1**: データベース拡張の動作確認

### テスト方針
- **既存機能の保護**: 既存機能に影響がないことを確認
- **段階的検証**: 各機能を個別にテスト
- **ロールバック準備**: 問題発生時の対応手順を確認

### テスト環境
- **本番環境**: Render + Supabase
- **テスト期間**: デプロイ後24時間
- **監視項目**: パフォーマンス、エラー率、機能動作

## テスト項目

### 1. 環境変数の確認

#### 1.1 バックエンドAPI環境変数
**テスト項目**: 予測関連の環境変数が正しく設定されている
**テスト方法**:
```bash
# ヘルスチェックエンドポイントで確認
curl https://your-api-url.onrender.com/api/health
```

**期待結果**:
```json
{
  "status": "OK",
  "message": "Regular Shopping App API is running",
  "predictions": {
    "enabled": false,
    "allowlistEnabled": false,
    "allowlistSize": 0,
    "predictorUrlConfigured": true
  }
}
```

**確認ポイント**:
- [ ] `predictions.enabled`が`false`
- [ ] `predictions.allowlistEnabled`が`false`
- [ ] `predictions.predictorUrlConfigured`が`true`

#### 1.2 フロントエンド環境変数
**テスト項目**: フロントエンドの予測フラグが正しく設定されている
**テスト方法**:
1. ブラウザでフロントエンドURLにアクセス
2. 開発者ツールでコンソールを開く
3. 予測機能が表示されていないことを確認

**期待結果**:
- 予測確率の表示がない
- 既存のUIに変更がない

### 2. データベース構造の確認

#### 2.1 テーブル存在確認
**テスト項目**: `last_purchases`テーブルが正しく作成されている
**テスト方法**:
```sql
-- Supabase SQL Editorで実行
SELECT table_name FROM information_schema.tables WHERE table_schema = 'public' ORDER BY table_name;
```

**期待結果**:
```
table_name   
----------------
 couples
 last_purchases
 regular_items
 share_links
(4 rows)
```

#### 2.2 テーブル構造確認
**テスト項目**: `last_purchases`テーブルの構造が正しい
**テスト方法**:
```sql
-- Supabase SQL Editorで実行
\d last_purchases
```

**期待結果**:
- `id` (SERIAL PRIMARY KEY)
- `couple_id` (VARCHAR NOT NULL)
- `item_id` (VARCHAR NOT NULL)
- `last_purchased_at` (TIMESTAMP NOT NULL)
- `created_at`, `updated_at` (TIMESTAMP)
- `UNIQUE(couple_id, item_id)`制約
- 外部キー制約（`couples.couple_id`, `regular_items.item_id`）

#### 2.3 インデックス確認
**テスト項目**: 必要なインデックスが作成されている
**テスト方法**:
```sql
-- Supabase SQL Editorで実行
SELECT indexname FROM pg_indexes WHERE tablename = 'last_purchases';
```

**期待結果**:
- `idx_last_purchases_couple_id`
- `idx_last_purchases_item_id`
- `idx_last_purchases_purchased_at`

### 3. 既存機能の動作確認

#### 3.1 認証機能
**テスト項目**: ログイン・ログアウトが正常に動作する
**テスト方法**:
1. 既存の夫婦IDでログイン
2. ログアウト
3. 新規夫婦登録
4. 新規登録した夫婦IDでログイン

**期待結果**:
- ログイン・ログアウトが正常に動作
- 新規登録が正常に動作
- エラーが発生しない

#### 3.2 アイテム管理機能
**テスト項目**: アイテムの追加・削除・一覧表示が正常に動作する
**テスト方法**:
1. アイテムを追加（複数カテゴリ）
2. アイテム一覧を確認
3. アイテムを削除
4. カテゴリ別表示を確認

**期待結果**:
- アイテムの追加・削除が正常に動作
- カテゴリ別表示が正常に動作
- エラーが発生しない

#### 3.3 共有機能
**テスト項目**: 共有機能が正常に動作する
**テスト方法**:
1. 共有IDを保存
2. 共有リンクにアクセス
3. 共有リンクでアイテム一覧を確認

**期待結果**:
- 共有機能が正常に動作
- 共有リンクでアイテム一覧が表示される
- エラーが発生しない

### 4. パフォーマンス確認

#### 4.1 API応答時間
**テスト項目**: APIの応答時間が許容範囲内
**テスト方法**:
```bash
# ヘルスチェックの応答時間
time curl https://your-api-url.onrender.com/api/health

# アイテム一覧取得の応答時間
time curl -H "Authorization: Bearer [valid-token]" https://your-api-url.onrender.com/api/items
```

**期待結果**:
- ヘルスチェック: 3秒以内
- アイテム一覧取得: 5秒以内

#### 4.2 フロントエンド読み込み時間
**テスト項目**: フロントエンドの読み込み時間が許容範囲内
**テスト方法**:
1. ブラウザでフロントエンドURLにアクセス
2. 開発者ツールのNetworkタブで読み込み時間を確認

**期待結果**:
- 初回読み込み: 5秒以内
- 2回目以降: 3秒以内

### 5. エラーハンドリング確認

#### 5.1 データベース接続エラー
**テスト項目**: データベース接続エラー時の適切な処理
**テスト方法**:
1. 一時的にデータベース接続を切断（Supabaseでメンテナンスモード）
2. APIリクエストを実行
3. 適切なエラーメッセージが表示されることを確認

**期待結果**:
- 適切なエラーメッセージが表示される
- アプリケーションがクラッシュしない

#### 5.2 ネットワークエラー
**テスト項目**: ネットワークエラー時の適切な処理
**テスト方法**:
1. ネットワーク接続を一時的に切断
2. APIリクエストを実行
3. 適切なエラーメッセージが表示されることを確認

**期待結果**:
- 適切なエラーメッセージが表示される
- アプリケーションがクラッシュしない

### 6. セキュリティ確認

#### 6.1 認証・認可
**テスト項目**: 認証・認可が正しく動作する
**テスト方法**:
1. 無効なトークンでAPIリクエストを実行
2. 認証なしでAPIリクエストを実行
3. 適切なエラーが返されることを確認

**期待結果**:
- 無効なトークンで401エラーが返される
- 認証なしで401エラーが返される

#### 6.2 データアクセス制御
**テスト項目**: データアクセス制御が正しく動作する
**テスト方法**:
1. 別の夫婦IDでログイン
2. 他の夫婦のデータにアクセスできないことを確認

**期待結果**:
- 他の夫婦のデータにアクセスできない
- 適切なエラーメッセージが表示される

## テスト実行手順

### 事前準備
1. テスト用の夫婦IDを準備
2. テスト用のアイテムデータを準備
3. ブラウザの開発者ツールを開く
4. ネットワーク監視ツールを準備

### テスト実行順序
1. **環境変数確認** (5分)
2. **データベース構造確認** (10分)
3. **認証機能テスト** (15分)
4. **アイテム管理機能テスト** (20分)
5. **共有機能テスト** (15分)
6. **パフォーマンステスト** (10分)
7. **エラーハンドリングテスト** (15分)
8. **セキュリティテスト** (10分)

### テスト結果記録
- [ ] 各テスト項目の結果を記録
- [ ] 問題が発生した場合は詳細を記録
- [ ] パフォーマンス測定値を記録
- [ ] エラーログを保存

## 問題発生時の対応

### 軽微な問題
**症状**: 一部の機能でエラーが発生するが、全体の動作に影響がない
**対応**:
1. エラーの詳細を記録
2. 開発環境で再現を試行
3. 修正後に再テスト

### 重大な問題
**症状**: 主要機能が動作しない、パフォーマンスが大幅に低下
**対応**:
1. 即座にロールバックを実行
2. 問題の詳細を記録
3. 開発環境で原因を特定
4. 修正後に再デプロイ

### 緊急時の連絡先
- 開発チーム: GitHub Issueで報告
- 運用チーム: 直接連絡

## 成功基準

### 必須項目
- [ ] すべての既存機能が正常に動作
- [ ] データベース構造が正しく作成されている
- [ ] 環境変数が正しく設定されている
- [ ] パフォーマンスが許容範囲内
- [ ] エラーハンドリングが適切に動作

### 推奨項目
- [ ] レスポンス時間が目標値を下回る
- [ ] エラー率が1%未満
- [ ] ユーザビリティに問題がない

## 次のステップ

### テスト完了後
1. **テスト結果の報告**: 結果をチームに共有
2. **問題の修正**: 発見された問題を修正
3. **フェーズ2の準備**: 次のフェーズの実装開始

### 継続監視
- [ ] 24時間の監視を継続
- [ ] エラーログの定期確認
- [ ] パフォーマンスメトリクスの確認

## 参考資料

- [Issue #38](https://github.com/atsushimemet/regular-member/issues/38)
- [デプロイ手順](./issue-38-predict-inventory-in-refrigerator-deployment.md)
- [フェーズ0-1の実装詳細](./issue-38-predict-inventory-in-refrigerator-transition-plan.md)
- [予測機能の要件定義](./issue-38-predict-inventory-in-refrigerator-requirements.md) 
